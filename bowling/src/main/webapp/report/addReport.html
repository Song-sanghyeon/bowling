<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Add report</title>
<style>
	#board {
		width:700px;
		text-align:center;
		height:150px;
	}
	#nameframe {
		width:100px;
	}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
	<h1>Insert Form</h1>
	<div id="getGame">
		<h2>GetTeam</h2>
		<div>
			<span id="getStadium"></span>
		</div>
		<!-- hometeam 선택 -->
		<select id = "getHomeTeam">
			<option>팀 선택</option>
		</select>
		
		<!-- hometeam 선수 선택 -->
		<select id = "getHomeTeamPlayer">
			<option value=0>선수 선택</option>
		</select>
		
		<!-- awayteam 선택 -->
		<select id = "getAwayTeam">
			<option>팀 선택</option>
		</select>
		
		<!-- awayteam 선수 선택 -->
		<select id = "getAwayTeamPlayer">
			<option value=0>선수 선택</option>
		</select>
	</div>
	
	<button id="gameStartBtn">게임시작</button>
	
	<div id="addPin">
		<h2>Insert Pin</h2>
		<!-- 전광판 -->
		<div>게임ID: <p id="gameNumber"></p></div>
		<div>
			<table border = "1" id="board">
				<tr>
					<td id="nameframe">이름/프레임</td>
					<td>1</td>
					<td>2</td>
					<td>3</td>
					<td>4</td>
					<td>5</td>
					<td>6</td>
					<td>7</td>
					<td>8</td>
					<td>9</td>
					<td>10</td>
					<td>총 점수</td>
				</tr>
				<tr>
					<td id="homeTeamPlayer"></td>
					<td id="h1"></td>
					<td id="h2"></td>
					<td id="h3"></td>
					<td id="h4"></td>
					<td id="h5"></td>
					<td id="h6"></td>
					<td id="h7"></td>
					<td id="h8"></td>
					<td id="h9"></td>
					<td id="h10"></td>
					<td></td>
				</tr>
				<tr>
					<td id="awayTeamPlayer"></td>
					<td id="a1"></td>
					<td id="a2"></td>
					<td id="a3"></td>
					<td id="a4"></td>
					<td id="a5"></td>
					<td id="a6"></td>
					<td id="a7"></td>
					<td id="a8"></td>
					<td id="a9"></td>
					<td id="a10"></td>
					<td></td>
				</tr>
			</table>
		</div>
		<br>
		<table border="1">
		<!-- addReport폼 생성, Check 박스 생성 -->
			<tr>
				<td>1<input class="pinCheck" type="checkbox" id="pin1"></td>
				<td>2<input class="pinCheck" type="checkbox" id="pin2"></td>
				<td>3<input class="pinCheck" type="checkbox" id="pin3"></td>
				<td>4<input class="pinCheck" type="checkbox" id="pin4"></td>
				<td>5<input class="pinCheck" type="checkbox" id="pin5"></td>
				<td>6<input class="pinCheck" type="checkbox" id="pin6"></td>
				<td>7<input class="pinCheck" type="checkbox" id="pin7"></td>
				<td>8<input class="pinCheck" type="checkbox" id="pin8"></td>
				<td>9<input class="pinCheck" type="checkbox" id="pin9"></td>
				<td>10<input class="pinCheck" type="checkbox" id="pin10"></td>
			</tr>
		</table>
		<br>
		<button type="button" id="addPinBtn">쓰러진 핀 입력</button>
		<div>
			<button type="button" id="strikeBtn">스트라이크</button>
			<button type="button" id="resetBtn">초기화</button>
		</div>
	</div>
</body>
<script>
	$(document).ready(function(){
		// 변수
		// pin : 볼링 핀의 배열 초기값은 0으로 설정 
		let pin = [0,0,0,0,0,0,0,0,0,0];
		// turn1PinSum : 처음 쓰러트린 핀의 갯수
		let pinSum = 0;
		
		// turn : 해당선수의 회차
		let turn = 1;
		// frame : 해당선수의 프레임
		let frame = 1;
		// player : 선수의 차례를 구분하기위한 변수
		// player의 값이 1 : awayTeamPlayer
		// player의 값이 2 : homeTeamPlayer
		let player = 1;
			
		// game_no 해당 경기의 인덱스값
		let gameNo = 0;
		
		// 팀을 선택하기전에 핀을 숨겨 놓는다
		//$("#addPin").hide();
		$("#homeTeamPlayerSelect").empty();

		//게임시작 버튼 클릭시 경기의 데이터를 기록할 수 있다
		$("#gameStartBtn").on("click",function(){
			if($("#getHomeTeamPlayer").val()!=0	&& $("#getAwayTeamPlayer").val()!=0){
				$("#gameStartBtn").hide();
				$("#getGame").hide();
				$("#addPin").show();
				
				// ### 경기 기록 ######################################################################################################################
				$.ajax({
					url:"/addGame",
					method:"POST",
					data:{"hteamName":$("#getHomeTeam").val(),
						  "stadiumName":$("#getStadium").text(),
						  "ateamName":$("#getAwayTeam").val()
						 },
					success:function(json){
						console.log("success!",json);
						gameNo = json.gameNo;
					}
				});
				
				// ### 홈 팀 구장 가져오기 ######################################################################################################################
			}else{
				alert("팀과 선수를 입력해주세요!");
			}
		});

// ### 팀 / 선수 선택 #############################################################################################
		// homeTeam 팀 명단을 불러오는 함수
		$.ajax({
			url:"/getHomeTeam",
			method:"POST",
			success:function(json){
				$(json).each(function(index, item){
					temp = "<option value='";
					temp += item.teamName;
					temp += "'>";
					temp += item.teamName;
					temp += "</option>";
					$("#getHomeTeam").append(temp);
				});
			}
		});
		
		// hometeam 선수를 불러오는 함수
		$("#getHomeTeam").change(function(){
			$.ajax({
				url:"/getHomeTeamPlayer",
				method:"POST",
				data:{"teamName":$("#getHomeTeam").val()},
				success:function(json){
					$("#getHomeTeamPlayer").empty();
					$("#getHomeTeamPlayer").append("<option value=0>선수 선택</option>");
					$(json).each(function(index, item){
						console.log("히오스");
						temp = "<option value='";
						temp += item.playerNo;
						temp += "'>";
						temp += item.playerName;
						temp += "</option>";
						$("#getHomeTeamPlayer").append(temp);
					});
				} 
			});
			
			// addReport 에서 경기 입력폼에서 경기장 출력
			$.ajax({
				url:"/getStadium",
				method:"POST",
				data:{"teamName":$("#getHomeTeam").val()},
				success:function(json){
					$("#getStadium").text(json.stadiumName);
				}
			});
			
			// away team을 불러오는 함수
			$.ajax({
				url:"/getAwayTeam",
				method:"POST",
				data:{"teamName":$("#getHomeTeam").val()},
				success:function(json){
					$("#getAwayTeam").empty();
					$("#getAwayTeam").append("<option value=0>팀 선택</option>");
					$(json).each(function(index, item){
						temp = "<option value='";
						temp += item.teamName;
						temp += "'>";
						temp += item.teamName;
						temp += "</option>";
						$("#getAwayTeam").append(temp);
					});
				}
			});
		});
		
		// away team 선수를 불러오는 함수
		$("#getAwayTeam").change(function(){
			$.ajax({
				url:"/getHomeTeamPlayer",
				method:"POST",
				data:{"teamName":$("#getAwayTeam").val()},
				success:function(json){
					$("#getAwayTeamPlayer").empty();
					$("#getAwayTeamPlayer").append("<option value=0>선수 선택</option>");
					$(json).each(function(index, item){
						temp = "<option value='";
						temp += item.playerNo;
						temp += "'>";
						temp += item.playerName;
						temp += "</option>";
						$("#getAwayTeamPlayer").append(temp);
					});
				}
			});
		});
		
		// 선수의 이름을 전광판에 입력시키는 함수
		$("#getHomeTeamPlayer").change(function(){
			$("#homeTeamPlayer").empty();
			$("#homeTeamPlayer").text($("#getHomeTeamPlayer option:checked").text());	
		})
		
		$("#getAwayTeamPlayer").change(function(){
			$("#awayTeamPlayer").empty();
			$("#awayTeamPlayer").text($("#getAwayTeamPlayer option:checked").text());
		})
		
// ### 팀 / 선수 선택 #############################################################################################
		
		$("#strikeBtn").on("click",function(){
			$(".pinCheck").prop("checked", true);
		});
		
		$("#resetBtn").on("click",function(){
			$(".pinCheck").prop("checked", false);
		});
		
// ### 핀 입력 ############################################################################################################
		$("#addPinBtn").on("click",function(){
			console.log("버튼클릭");
			
			
			// 볼링핀을 체크박스로 설정하여 체크한 핀의 배열 인덱스 값을 1로 설정
			// 인덱스 값이 1은  쓰러트린 핀, 인덱스 값이 0 은 쓰러트리지 않은 핀
			if($("input:checkbox[id='pin1']").is(":checked") == true){
				$("#pin1").attr("disabled",true);
				pin[0]=1;
			}
			
			if($("input:checkbox[id='pin2']").is(":checked") == true){
				$("#pin2").attr("disabled",true);
				pin[1]=1;
			}
			
			if($("input:checkbox[id='pin3']").is(":checked") == true){
				$("#pin3").attr("disabled",true);
				pin[2]=1;
			}
			
			if($("input:checkbox[id='pin4']").is(":checked") == true){
				$("#pin4").attr("disabled",true);
				pin[3]=1;
			}
			
			if($("input:checkbox[id='pin5']").is(":checked") == true){
				$("#pin5").attr("disabled",true);
				pin[4]=1;
			}
			
			if($("input:checkbox[id='pin6']").is(":checked") == true){
				$("#pin6").attr("disabled",true);
				pin[5]=1;
			}
			
			if($("input:checkbox[id='pin7']").is(":checked") == true){
				$("#pin7").attr("disabled",true);
				pin[6]=1;
			}
			
			if($("input:checkbox[id='pin8']").is(":checked") == true){
				$("#pin8").attr("disabled",true);
				pin[7]=1;
			}
			
			if($("input:checkbox[id='pin9']").is(":checked") == true){
				$("#pin9").attr("disabled",true);
				pin[8]=1;
			}
			
			if($("input:checkbox[id='pin10']").is(":checked") == true){
				$("#pin10").attr("disabled",true);
				pin[9]=1;
			}
			console.log(pin);
			
			//체크한 pin의 개수의 합을 구하는 반복문
			for(let i =0;i<pin.length;i++){
				pinSum += pin[i];
			}
			console.log(pinSum);
			console.log("turn :",turn);
			console.log("player :",player);
			console.log("frame :", frame);
			
			// home팀 전광판 frame
			let homeFrame = "#h"+frame;
			// away팀 전광판 frame
			let awayFrame = "#a"+frame;
			
			// 선수의 회차마다의 기록을 저장하기 위한 함수
			$.ajax({
				url:"/addGamePlayer",
				method:"POST",
				data:{"gameNo": gameNo,
					  "playerNo":$("#getHomeTeamPlayer").val(),
					  "frame":frame,
					  "turn":turn,
					  "pin1":pin[0],
					  "pin2":pin[1],
					  "pin3":pin[2],
					  "pin4":pin[3],
					  "pin5":pin[4],
					  "pin6":pin[5],
					  "pin7":pin[6],
					  "pin8":pin[7],
					  "pin9":pin[8],
					  "pin10":pin[9]
					 },
				success:function(){
					console.log("addGamePlayer 요청 확인!");
				}
			});
			
			// 1회차에 핀을 10개 쓰러트린 경우 (스트라이크)
			if(turn == 1 && pinSum == 10){
				if(frame == 10){
					console.log("strike");
					
					// 전광판에 스트라이크 출력
					if(player == 1){
						$(homeFrame).text(pinSum);
					} else {
						$(awayFrame).text(pinSum);
					}
					
					$(".pinCheck").attr("disabled", false);
					$(".pinCheck").prop("checked", false);
					pinSum = 0;
					pin = [0,0,0,0,0,0,0,0,0,0];
				} else {
					console.log("strike");
					
					// 전광판에 스트라이크 출력
					if(player == 1){
						$(homeFrame).text("X");
					} else {
						$(awayFrame).text("X");
					}
					
					$(".pinCheck").attr("disabled", false);
					$(".pinCheck").prop("checked", false);
					turn = 1;
					player += 1;
					pinSum = 0;
					pin = [0,0,0,0,0,0,0,0,0,0];
				}
			} else {
				console.log("------------------------");
				
				// 전광판에 쓰러트린 핀 출력
				if(player == 1){
					$(homeFrame).text(pinSum);
				} else {
					$(awayFrame).text(pinSum);
				}
				
				// 버튼 클릭 할 때마다 선수의 회차가 +1된다
				turn += 1;
				$(".pinCheck").prop("checked", false);
				pin = [0,0,0,0,0,0,0,0,0,0];
				
				if(turn > 2){
					$(".pinCheck").attr("disabled", false);
					$(".pinCheck").prop("checked", false);
					if(frame != 10 && pinSum < 10){
						player += 1;
						pinSum = 0;
						turn = 1;
						pin = [0,0,0,0,0,0,0,0,0,0];
					} else {
						if(turn > 3){
							player += 1;
							pinSum = 0;
							turn = 1;
							pin = [0,0,0,0,0,0,0,0,0,0];
						}
						
						pin = [0,0,0,0,0,0,0,0,0,0];
					}
				}
			}
			
			if(player > 2){
				player = 1;
				frame += 1;
			}
			
			//1회차일때 스트라이크버튼이 보이고, 2회차일때 스페어 버튼이 보인다.
			if(turn == 2){
				$("#spareBtn").show();
				$("#strikeBtn").hide();
			}else if(turn == 1){
				$("#strikeBtn").show();
				$("#spareBtn").hide();
			}
		})
	});
// ### 핀 입력 ############################################################################################################	

	
</script>
</html>